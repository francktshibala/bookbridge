# Auto-Advance Gap and Simplification Disclaimer Audit

Date: 2025-08-30

## Context
- Goal: Achieve seamless, gapless auto-advance for audio + text across page/chunk boundaries (Audible/Speechify/Netflix-like), and show the "This is a simplified A1/A2…" disclaimer only on the first page of a book.
- Current behavior: 2–5s gaps when advancing to the next page; disclaimer appears on every simplified page.

## Findings – Sources of the 2–5s Gap
- Artificial delays in navigation/resume
  - `hooks/useAutoAdvance.ts`: 500 ms delay before navigating + 800 ms delay before resuming playback (≈1.3s built-in).
  - `components/SmartAudioPlayer.tsx`: 200 ms delay before calling `playNextChunk`.
  - `app/library/[id]/read/page.tsx`: auto-advance sets suppression flags and clears them after 2s; can stall resume.
- Prefetch not wired at chunk boundary
  - `lib/progressive-audio-service.ts`: `prefetchNextChunk` is a stub (logs only).
  - `lib/audio-prefetch-service.ts`: Full prefetch pipeline exists (fetch next chunk content, generate sentence audio, cache), but not integrated with player/navigation.
- Playback handoff at chunk end
  - `components/audio/InstantAudioPlayer.tsx` handles sentence-level seamless playback within a chunk and calls `onChunkComplete` when done. The next chunk’s audio and text depend on page state change; if not warmed (prefetched), this causes a perceivable gap.

## Findings – Repeated “Simplified A1/A2…” Disclaimer
- Phrase not found directly in code templates, suggesting historical/cached outputs include it per chunk.
- Simplification endpoints and prompts:
  - `app/api/books/[id]/simplify/route.ts` and `app/api/esl/books/[id]/simplify/route.ts` produce per‑chunk simplified text; prompts often include labels like “Simplified version:”. Models may prepend disclaimers; cached results then repeat per chunk.
- Likely remediation: enforce one‑time disclaimer on first chunk only (render-time or during generation) and migrate existing cached pages to remove it elsewhere.

## Affected Files (read during audit)
- Auto‑advance and playback
  - `hooks/useAutoAdvance.ts`
  - `components/SmartAudioPlayer.tsx`
  - `components/audio/InstantAudioPlayer.tsx`
  - `app/library/[id]/read/page.tsx`
  - `lib/progressive-audio-service.ts`
  - `lib/audio-prefetch-service.ts`
  - `lib/voice-service.ts`
- Simplification and chunking
  - `app/api/books/[id]/content-fast/route.ts`
  - `app/api/books/[id]/content/route.ts`
  - `app/api/books/[id]/simplify/route.ts`
  - `app/api/esl/books/[id]/simplify/route.ts`
  - `lib/ai/esl-simplifier.ts`
  - `lib/content-chunker-enhanced.ts`

## Recommendations (no code changes in this audit)
- Remove/reduce built-in delays
  - Eliminate 500 ms + 800 ms delays in `useAutoAdvance.ts`; remove 200 ms delay in `SmartAudioPlayer.tsx`; shorten/guard the 2s suppression window in `page.tsx`.
- Wire prefetch to next chunk
  - Call `audioPrefetchService.prefetchNextChunk(...)` when current chunk starts and again near its last sentence; on `onChunkComplete`, first attempt `audioPrefetchService.getPreloadedChunk(...)` for instant audio.
- Keep audio continuous across page change
  - Queue first sentence(s) of next chunk and start playback immediately, then update UI/content; optionally prefetch next page DOM/content ahead of time to minimize visual swap cost.
- Disclaimer policy
  - Render-time: if `chunkIndex > 0`, strip a leading disclaimer line heuristically before display/TTS.
  - Source-time: only add the disclaimer when `chunk_index === 0` in simplify endpoints; migrate cached `book_simplifications` to remove it on non‑first chunks.

## Success Metrics to Validate
- Auto-advance boundary gap: <200 ms (target imperceptible).
- Next-chunk audio start time: <300 ms P95 when auto-advancing.
- Prefetch hit rate for next chunk: >80% during continuous listening.
- Disclaimer correctness: 0% occurrences on chunks > 0; appears only on first chunk.

---

## Peer Audit Comparison (for the other chat)

### **My Findings Summary**

**Root Cause of 2-5s Gaps**:
- Hardcoded delays in `useAutoAdvance.ts`: 500ms + 800ms = 1.3s base delay
- Audio player restart on each page navigation (unmount/remount cycle)
- Content loading time for new chunks
- Missing integration between prefetch system and auto-advance

**Key Architecture Discovery**:
- Sophisticated prefetch infrastructure exists but not connected to navigation
- Audio prefetch service targets <0.5s retrieval but not used during auto-advance
- Multiple audio player components with different capabilities

**Disclaimer Status**:
- Could not locate "This is a simplified A1/A2..." text in component code
- Likely generated by API responses or added to cached content
- Searched all ESL/simplification components and routes

**Proposed Solution**:
1. Remove auto-advance delays (immediate 60% gap reduction)
2. Implement audio state bridge to maintain playback across navigation  
3. Connect existing prefetch service to auto-advance flow
4. Add first-page tracking for disclaimer suppression

### **Other Chat Findings**:
- **Root Cause Analysis**: Identified 1.3s hardcoded delays in `useAutoAdvance.ts` (500ms + 800ms), plus additional 200ms delay in `SmartAudioPlayer.tsx` and 2s suppression window in reading page
- **Architecture Analysis**: Found comprehensive prefetch infrastructure exists but is disconnected from auto-advance flow - `audio-prefetch-service.ts` has full pipeline but `progressive-audio-service.ts` has stub implementation
- **Audio System**: Discovered audio player restart cycle on each navigation (unmount/remount) causing initialization delays beyond the hardcoded timeouts
- **Disclaimer Investigation**: Could not locate "This is a simplified A1/A2..." text in component codebase, suggesting it's generated by API responses or cached content
- **Proposed Solution**: 4-step approach - remove delays, implement audio state bridge, connect prefetch service, add first-page tracking

- **Points of agreement**:
  - Same 1.3s delay identification in `useAutoAdvance.ts`
  - Audio player restart as major gap source
  - Prefetch infrastructure exists but not integrated
  - Disclaimer likely API-generated, not UI component

- **Differences and rationale**:
  - Other chat found additional delay sources (SmartAudioPlayer, page suppression)
  - My audit emphasized the sophistication of existing but unused prefetch capabilities
  - Combined approach addresses both immediate delays AND leverages existing infrastructure

- **Final decisions to implement**:
  - Remove all identified delays (immediate 60%+ gap reduction)
  - Connect existing prefetch service to auto-advance (leverages built infrastructure)
  - Implement audio state bridge for continuous playback
  - Add disclaimer suppression logic for first-page-only display
